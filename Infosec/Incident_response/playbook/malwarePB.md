# Example of Malware Playbook (using the IR process to create it) and starting with preperation

* Starts with Preperation of playbook which requires:
  * Relevant Logs
    * EDR logs
    * Sysmon logs
    * Syslog
    * Windows event logs
    * Network communication logs
  * Required Fields
    * Process names
    * Parent process names
    * Process ID
    * File/Process hashes
    * Process image path
    * Command line parameters
    * Activity details
  * Possible Use Cases
    * Suspicious parent-child relationship
    * Suspicious file access
    * Suspicious registry events
    * Suspicious network activity
  * Recommended Security Controls
    * Malware quarantine in EDR
    * Shellcode blocking
    * Exploit prevention

## Playbook: Detection and Analysis

* A malware detection will often trigger a malware playbook.
  * Sometimes, malware playbooks can be further fleshed into different playbooks such as ransomware, infostealer, process injection, and more.
    * Some use cases that might trigger the malware playbook are as follows:
      * EDR marked a process as malicious
      * Suspicious file executing from temp directory
      * Browser executing a suspicious script engine such as PowerShell or CMD

* Once any of the above-mentioned use cases get triggered, the analyst will perform the following steps to verify the alert (aka Analysis):
  * Identify the process that triggered the alert.
  * To identify the binary's reputation, check the process's hash on VirusTotal, Hybrid Analysis, or similar platforms.
  * On VirusTotal, check if the process is marked as safe, distributed by a known vendor, or if it is signed by that vendor.
    * Important Note: Do not upload the binary to VirusTotal or any other third-party platform without consulting your management.
  * If the process is clean but was used to execute a file (such as an MS Word file, PDF file, or PowerShell script), analyse the executed file using VirusTotal, Hybrid Analysis, or other similar platforms.
  * Check the parent process of the process that triggered the alert.
    * Using the above steps, see if the parent process is clean or malicious.
  * Identify how the process/file landed on the affected system.
    * Check network or proxy logs to identify suspicious downloads or email logs to identify if the file was delivered through a phishing email.
  * If a phishing email was involved, trigger the phishing playbook.
  * Execute the malware in a private sandbox (if available) to understand its behaviour.
    * Note the malware's activities in a document, which will be used for later containment actions.
  * Preserve evidence of malicious activity, like taking memory, disk, or triage images, without turning off the affected systems (if required).
  * Perform forensic analysis of the collected forensic data to identify further IOCs.
  * Perform an organisation-wide threat hunt to identify all affected machines.

### Playbook: Containment, Eradication, and Recovery

* Containment
  * The following steps can outline an effective containment strategy for malware.
    * Isolate all the affected systems from the network.
    * Revoke sessions of all the accounts logged in to the affected systems.
    * Block any communication to potential C2 servers.

* Eradication
  * Once the malware threat is contained, the following steps might be taken to eradicate it.
    * Shut down the services run by the malicious process.
    * Remove the binary of the malicious process from the affected systems, if possible.
    * If required, reimage the affected systems.
    * Run a complete EDR scan on the machines to ensure malware removal.
    * Reset the credentials of all the affected user accounts.

* Recovery
  * After eradication of the malware, the following steps can be taken for full recovery.
    * Enable MFA on all affected accounts and ensure strong passwords are created as per policy (to cover for infostealers/spyware malware).
    * Audit the malware's activity and revert its changes in the affected systems (e.g., adding database entries, changing  webpage or other such changes).
    * Return the affected machines to the last known good configuration and resume services.

#### Playbooks: Post-Incident Activity

* The post-incident activity is guided by broad guidelines outlined in the *IR plan instead of the playbooks.*
