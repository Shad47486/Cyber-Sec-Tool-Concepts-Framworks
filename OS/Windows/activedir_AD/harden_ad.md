# How TO HARDEN ACTIVE DIRECTORY?

* Securing Authentication Methods
* Implementing Least Privilage Models
* Microsoft Security Compliance Toolkit
* Protecting Against Known Attacks

*[cheat sheet](/activedir(AD)/hardenchatsheet.png)*

## Securing Authentication Methods

* Use the built-in Microsoft tool Group Policy Management Editor (edit default domain policy) in server manager tools for configuring various security policies

* LAN Manager Hash:
  * When the password for any user account is changed or set with fewer than 15 characters, both LM hash (LAN Manager hash) and NT hash (Windows NT hash) are generated by Windows and can be stored in AD.
    * The user account password for Windows isn't stored in clear text; instead, it stores passwords with two types of hash (LM hash & NT hash).
  * LM hash is relatively weaker than the NT and is prone to a fast brute-force attack
    * Best recommendation is to prevent Windows from storing the password's LM hash
      * Can be access from the following: Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options > double click Network security - Do not store LM hash value on next password change policy > select "Define policy setting"

* Server message block (SMB) Signing:
  * Microsoft-based networks utilise this protocol for file and print communication
    * It allows secure transmission over the network
    * Configuring SMB signing through group policy is crucial to detect Man in the Middle (MiTM) attacks that may result in modification of SMB traffic in transit.
    * All supported Windows versions have an SMB packet signing option.
  * SMB signing ensures the integrity of data for both client and server
    * To enagle SMB Signing: Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options > double click Microsoft network server: Digitally sign communication (always) > select Enable Digitally Sign Communications

* Light Weight Directory Access Protocol (LDAP) Signing
  * LDAP enables locating and authenticating resources on the network.
    * Hackers may introduce replay or MiTM attacks to launch custom LDAP requests.
      * Therefore, LDAP signing is a Simple Authentication and Security Layer (SASL) property that only accepts signed LDAP requests and ignores other requests (plain-text or non-SSL).
    * To enable LDAP signing: Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options > Domain controller: LDAP server signing requirements > select Require signing from the dropdown

* ROTATING AD PASSWORDS
  * password security is critical to address because of security breaches and password reuse
  * Becomes challenging for any organisation to reset account passwords or update them everywhere, so they prefer not to do it.
  * Here are a few approaches:
    * First Technique:
      * Creating a script to update passwords automatically in the Scheduled Task with the help of PowerShell.
        * This method does not require any additional overhead and removes all the manual efforts for password rotation, but it requires you to write and maintain your script â€“ which could be challenging.
    * Second Technique:
      * Add a Multi-Factor Authentication (MFA) solution to AD and choose not to change the password often.
      * It adds a security layer, and you will not need to change your password often.
    * Third Technique:
      * Microsoft provides a solution for services account password rotation through Group Managed Services Accounts (gMSAs), which changes passwords after every 30 days.
  * All orgs must have a strict password policy to defend against all such attacks
    * Password policies mean different rules for creating passwords, including length, complexity, and changing frequency.
      * Enforce password history, min password length, complexity requirements (upper/lowercase, digits, special characters)
    * To view Configuration go to: Group Policy Management Editor > Computer Configuration > Policies > Windows Settings > Security Settings > Account Policies > Password Policy

### Implement Least Privilege Model

* Implementing the least privilege model requires limiting the user or application access to minimise security risks and attack surfaces

* Different types of accounts are need in a Least privilage model:
  * User accounts: You must promote using regular user accounts for most people in the network, who are necessary to perform their regular duties.
  * Privilege accounts: These are the accounts with elevated privileges & are further classified as 1st & 2nd privilege accounts.
  * Shared accounts: These accounts are shared amongst a group of people, as the visitors with bare minimum privileges, to give limited access for a specific time.
    * Shared accounts are not recommended and must be utilised in limited scenarios.

* Role-Based Access Control on Hosts:
  * Role-based access control allows you to indicate access privileges at different levels.
    * Including DNS zone, server, or resource record levels and specifies who has access control over creating, editing, and deleting operations of various resources of AD.

* Active Directory Tiered Access Model (TAM)
  * Comprises plenty of technical controls that reduce the privilege escalation risks
  * Consists of a logical structure that separates AD's assets by creating boundaries for security purposes.
    * Primary goal is the protection of Active Directory's top-valued identities (Tier 0).
    * At the same time, domain members and other users can perform routine tasks, such as email checking, surfing the internet, and using apps and other services (Tier 1/2)
  * Comprises of 3 tiers:
    * Tier 0: Top level and includes all the admin accounts, Domain Controller, and groups.
    * Tier 1: Domain member applications and servers.
    * Tier 2: End-user devices like HR and sales staff (non-IT personnel).

* The implementation of TAM is based on the principle of "Prevention of privileged credentials from crossing boundaries, either accidentally or intentionally"
  * Implementing technical controls via Group Policy Objects is crucial to avoid such scenarios.
  * GPOs put together the security rights that can deny access or grant permission

* Auditing Accounts:
  * Accounts audit is a crucial task mainly carried out by setting up the correct account, assigning privileges, and applying restrictions.
    * 3 audit types must be done periodically (usage, privilege, & change audits)
      * Usage audits allow monitoring each account's specific tasks and validating their access rights.
      * Privilege audit allows you to check if every account in the system has the least privilege.
      * Change audits allow you to look for any improper changes to account permissions, passwords, or settings.
        * Any unacceptable change to these may lead to a data breach.

#### Microsoft Security Compliance Toolkit

* Microsoft Security Compliance Toolkit (MSCT) is an official toolkit provided by Microsoft to implement and manage local and domain-level policies.
  * Microsoft will provide pre-developed security baselines per the end user environment.

* Installing Security Baselines:
  * Microsoft offers its customers security baselines readily available in consumable formats, like, GPOs Backups
    * How to Download & install: Open Microsoft Security Compliance Website > click Download > click Windows Servers Security Baseline.zip > Download > Open extracted folder > Scripts > & select desired baseline & execute with PowerShell

* One of the Security Compliance ToolKit's features is a policy analyser which allows comparison of group policies to quickly check inconsistencies, redundant settings, and the alterations that need to be made between them
  * EX: Plenty of GPOs are applied at diverse levels.
    * There will be conflicting, redundant settings and many more avenues that can be quickly resolved with a policy analyser.
    * Same as security baselines, it is downloaded as a zip file from the same link, and one can easily extract the content and then follow the procedure.
    * Once downloaded, you can run the PolicyAnalyzer.exe to add and manage local or domain-level policies.

##### Protecting Against Known Attacks

* Kerberoasting
  * Common and successful post-exploitation technique for attackers to get privileged access to AD
    * Attacker exploits Kerberos Ticket Granting Service (TGS) to request an encrypted password, and then the attacker cracks it offline through various brute force techniques
    * Difficult to detect as the request is made through an approved user, and no unusual traffic pattern is generated during this process.
      * Prevent the attack by ensuring an additional layer of authentication through MFA or by frequent and periodic Kerberos Key Distribution Centre (KDC) service account password reset

* Weak and Easy-to-Guess Passwords
  * Easiest target for intruders to breach security is the weak and easy-to-guess old passwords.
    * Best recommendation is to use strong passwords and avoid already known ones

* Brute Forcing Remote Desktop Protocol
  * Intruders or attackers use scanning tools to brute force the weak credentials.
  * Once the brute force is successful, they quickly access the compromised systems and try to do privilege escalation along with a persistent foothold in the target's computer
    * Best recommendation is to never expose RDP without additional security controls to the public internet.
    * Continuous audits for scanning attacks or brute-force attempts are also an important step.

* Publically Accessible Share
  * During AD configuration, some share folders are publicly accessible or left unauthenticated, providing an initial foothold for attackers for lateral movement.
    * You can use the Get-SmbOpenFile cmdlet in PowerShell to look for any undesired share on the network and configure access accordingly.
